"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const settings_1 = require("../settings");
const pg_1 = require("../pg");
const migration_1 = require("../migration");
const pgMinify = require("pg-minify");
const fsp = require("../fsp");
async function _status(parsedSettings) {
    const connectionString = parsedSettings.connectionString;
    if (!connectionString) {
        throw new Error("Could not determine connection string");
    }
    return pg_1.withClient(connectionString, parsedSettings, async (pgClient) => {
        const lastMigration = await migration_1.getLastMigration(pgClient, parsedSettings);
        const remainingMigrations = await migration_1.getMigrationsAfter(parsedSettings, lastMigration);
        const currentMigrationPath = settings_1.getCurrentMigrationPath(parsedSettings);
        const body = await fsp.readFile(currentMigrationPath, "utf8");
        const minifiedBody = pgMinify(body);
        const hasCurrentMigration = minifiedBody !== "";
        return {
            remainingMigrations: remainingMigrations.map(m => m.filename),
            hasCurrentMigration,
        };
    });
}
async function status(settings) {
    const parsedSettings = await settings_1.parseSettings(settings, true);
    return _status(parsedSettings);
}
exports.status = status;
//# sourceMappingURL=status.js.map